<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>پرسشنامه سبک فرزندپروری</title>
<style>
body {
    font-family: Tahoma, sans-serif;
    background-color: #d0f0c0; /* سبز ملایم */
    direction: rtl;
    padding: 20px;
}
.container {
    background-color: #fff;
    padding: 20px 30px;
    border-radius: 10px;
    max-width: 900px;
    margin: auto;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h1 { text-align: center; }
.question { margin-bottom: 15px; }
label { display: block; margin-bottom: 5px; }
input[type=text], select { width: 100%; padding: 8px; margin-bottom: 10px; }
button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top:10px; }
.result { margin-top: 20px; padding: 15px; background-color: #e2f0d9; border-radius: 8px; }
</style>
</head>
<body>
<div class="container">
<h1>پرسشنامه سنجش سبک فرزندپروری مبتنی بر تئوری انتخاب</h1>
<p>لطفاً مشخصات خود را وارد کرده و برای هر سؤال یکی از گزینه‌ها را انتخاب نمایید.</p>

<form id="surveyForm">
<label>نام:</label>
<input type="text" name="name" required>

<label>جنسیت:</label>
<input type="radio" name="gender" value="زن" required> زن
<input type="radio" name="gender" value="مرد" required> مرد

<label>سن:</label>
<input type="text" name="age" required>

<label>تحصیلات:</label>
<input type="text" name="education" required>

<hr>

<div id="questions"></div>

<button type="submit">ارسال و مشاهده نتیجه</button>
</form>

<div class="result" id="result" style="display:none;"></div>
<button id="downloadPDF" style="display:none;">دانلود PDF نتایج</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ========================= سوالات =========================
const questions = [
"در صورت بروز رفتار اشتباهی از فرزندم به او اطمینان می دهم که جدای از رفتارش او برای من ارزشمند است.",
"به فرزندم در مسائل شخصی اش مثل روابط اجتماعی و تحصیلی ...اعتماد دارم .",
// ... تا q40
"برای تنبیه فرزندم اجازه نمی دهم کار مورد علاقه اش را انجام دهد یا از وسایل مورد علاقه اش استفاده کند."
];

// گزینه‌ها و نمرات
const options = ["همیشه", "اغلب اوقات", "گاهی اوقات", "به ندرت", "هرگز"];
const scores = [4,3,2,1,0];

// ========================= تولید فرم سوالات =========================
const container = document.getElementById("questions");
questions.forEach((q,i)=>{
    let div = document.createElement("div");
    div.className = "question";
    let html = `<label>${i+1}. ${q}</label>`;
    options.forEach((opt,j)=>{
        html += `<input type="radio" name="q${i+1}" value="${scores[j]}" required> ${opt} `;
    });
    div.innerHTML = html;
    container.appendChild(div);
});

// ========================= ارسال فرم =========================
const form = document.getElementById("surveyForm");
form.addEventListener("submit", async function(e){
    e.preventDefault();
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value,key)=>{ data[key]=value; });

    try {
        // ارسال به Web App گوگل
        const res = await fetch("https://script.google.com/macros/s/AKfycbwRaIL9Qy2yHrdIhzMTB0RKE3PivbUgac3ZfyUzBCTkPJT2homKJ_C-jfcSeSrNZ41Dug/exec", {
            method: "POST",
            body: JSON.stringify(data)
        });
        await res.json();

        // محاسبه نمرات خرده مقیاس‌ها
        const constructive = { Supporting:[1,4,17], Encouraging:[10,12,18,32], Listening:[23,30,8], Accepting:[6,11,29,34], Trusting:[2], Respecting:[21,24], Negotiating:[7,20,25,33,38] };
        const destructive = { Criticizing:[13,26,27,36], Blaming:[22,31], Complaining:[3,14,16], Nagging:[19,35,37], Threatening:[8,15,39], Punishing:[40], Bribing:[5,9,28] };

        function calcScores(mapping){
            let scoresObj = {};
            for(const [k,arr] of Object.entries(mapping)){
                let sum=0;
                arr.forEach(idx=>{ sum+=parseInt(data[`q${idx}`]); });
                scoresObj[k]=sum;
            }
            return scoresObj;
        }

        const consScores = calcScores(constructive);
        const desScores = calcScores(destructive);

        let resultHtml = "<h3>نتایج شما:</h3><h4>سبک سازنده:</h4><ul>";
        for(const [k,v] of Object.entries(consScores)){ resultHtml += `<li>${k}: ${v}</li>`; }
        resultHtml += "</ul><h4>سبک مخرب:</h4><ul>";
        for(const [k,v] of Object.entries(desScores)){ resultHtml += `<li>${k}: ${v}</li>`; }
        resultHtml += "</ul>";
        document.getElementById("result").innerHTML = resultHtml;
        document.getElementById("result").style.display = "block";
        document.getElementById("downloadPDF").style.display = "inline-block";
    } catch(err){
        alert("خطا در ارسال داده‌ها: "+err);
    }
});

// ========================= دانلود PDF =========================
document.getElementById("downloadPDF").addEventListener("click", function(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:"p",unit:"mm",format:"a4"});
    const resultText = document.getElementById("result").innerText;
    doc.setFont("Tahoma");
    doc.setFontSize(12);
    doc.text(resultText, 10, 20);
    doc.save("نتایج_پرسشنامه.pdf");
});
</script>
</div>
</body>
</html>
